#!/usr/bin/env python3
"""
Generate a Minecraft-style bitmap font atlas

- 16x16 grid of ASCII characters (32..127 used)
- Each cell is 8x8 pixels
- Glyphs drawn from blocky 1px patterns (provided below)
- Variable advance width computed from glyph content (MC-like spacing)
- Optional 1px drop shadow (disabled by default; MC usually applies this at render time)
- Outputs:
    assets/font.png
    assets/font_widths.json
"""

from PIL import Image, ImageDraw
import os, json

# ===== Font/Atlas configuration =====
CHAR_WIDTH    = 8
CHAR_HEIGHT   = 8
CHARS_PER_ROW = 16
CHARS_PER_COL = 16
TOTAL_CHARS   = CHARS_PER_ROW * CHARS_PER_COL

FOREGROUND = (255, 255, 255, 255)
SHADOW     = (0, 0, 0, 160)   # dark translucent
ENABLE_SHADOW = False         # Set True to bake a 1px drop shadow (MC normally does this at runtime)

# Advance width constraints (Minecraft glyphs are usually 1..5px wide plus 1px padding)
MIN_ADVANCE = 1
MAX_ADVANCE = 7   # keep <= cell width; MC classic widths are often ≤6 incl. space; 7 gives a bit more for wide glyphs
RIGHT_PADDING = 1   # add a pixel so letters don’t touch

# ===== Image size =====
IMAGE_WIDTH  = CHAR_WIDTH * CHARS_PER_ROW
IMAGE_HEIGHT = CHAR_HEIGHT * CHARS_PER_COL

# ===== Create target image =====
img = Image.new('RGBA', (IMAGE_WIDTH, IMAGE_HEIGHT), (0, 0, 0, 0))
draw = ImageDraw.Draw(img)

# ===== Blocky glyph patterns (Revised for better readability) =====
# ===== Blocky glyph patterns (Revised for better readability) =====
font_patterns = {
    ' ': [],
    '!': [(3,0), (3,1), (3,2), (3,3), (3,4), (3,6)],
    '"': [(2,0), (2,1), (5,0), (5,1)],
    '#': [(1,1), (5,1), (0,2), (1,2), (2,2), (3,2), (4,2), (5,2), (6,2), (1,3), (5,3), (0,4), (1,4), (2,4), (3,4), (4,4), (5,4), (6,4), (1,5), (5,5)],
    '$': [(1,0), (2,0), (3,0), (4,0), (0,1), (2,2), (3,2), (4,2), (1,3), (2,3), (3,3), (5,4), (0,5), (1,5), (2,5), (3,5), (4,5)],
    '%': [(0,0), (1,0), (0,1), (1,1), (4,1), (3,2), (2,3), (1,4), (4,4), (5,4), (4,5), (5,5)],
    '&': [(1,0), (2,0), (3,0), (0,1), (1,1), (3,1), (4,1), (1,2), (2,2), (0,3), (4,3), (1,4), (4,4), (0,5), (3,5), (4,5)],
    '\'': [(3,0), (3,1)],
    '(': [(4,0), (3,1), (2,2), (2,3), (2,4), (3,5), (4,6)],
    ')': [(2,0), (3,1), (4,2), (4,3), (4,4), (3,5), (2,6)],
    '*': [(3,0), (1,1), (3,1), (5,1), (0,2), (1,2), (2,2), (3,2), (4,2), (5,2), (6,2), (1,3), (3,3), (5,3), (3,4)],
    '+': [(3,1), (1,2), (2,2), (3,2), (4,2), (5,2), (3,3)],
    ',': [(3,5), (2,6)],
    '-': [(1,3), (2,3), (3,3), (4,3), (5,3)],
    '.': [(3,5)],
    '/': [(5,0), (4,1), (3,2), (2,3), (1,4), (0,5)],
    '0': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (4,2), (5,2), (0,3), (3,3), (5,3), (0,4), (2,4), (5,4), (0,5), (1,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    '1': [(2,0), (3,0), (2,1), (2,2), (2,3), (2,4), (2,5), (1,6), (2,6), (3,6)],
    '2': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (5,2), (4,3), (3,4), (2,5), (0,6), (1,6), (2,6), (3,6), (4,6), (5,6)],
    '3': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (4,2), (3,3), (4,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    '4': [(4,0), (3,1), (4,1), (2,2), (4,2), (1,3), (4,3), (0,4), (1,4), (2,4), (3,4), (4,4), (5,4), (6,4), (4,5), (4,6)],
    '5': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (0,1), (0,2), (1,2), (2,2), (3,2), (4,2), (5,3), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    '6': [(2,0), (3,0), (4,0), (1,1), (0,2), (0,3), (1,3), (2,3), (3,3), (4,3), (0,4), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    '7': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (5,1), (4,2), (3,3), (2,4), (2,5), (2,6)],
    '8': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (1,3), (2,3), (3,3), (4,3), (0,4), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    '9': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (1,3), (2,3), (3,3), (4,3), (5,3), (5,4), (4,5), (1,6), (2,6), (3,6)],
    ':': [(3,1), (3,4)],
    ';': [(3,1), (3,4), (2,5)],
    '<': [(4,0), (3,1), (2,2), (1,3), (2,4), (3,5), (4,6)],
    '=': [(1,2), (2,2), (3,2), (4,2), (5,2), (1,4), (2,4), (3,4), (4,4), (5,4)],
    '>': [(1,0), (2,1), (3,2), (4,3), (3,4), (2,5), (1,6)],
    '?': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (5,2), (4,3), (3,4), (3,6)],
    '@': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (3,2), (4,2), (5,2), (0,3), (3,3), (5,3), (0,4), (5,4), (0,5), (1,5), (2,5), (3,5), (4,5)],
    'A': [(2,0), (3,0), (1,1), (4,1), (0,2), (5,2), (0,3), (1,3), (2,3), (3,3), (4,3), (5,3), (0,4), (5,4), (0,5), (5,5), (0,6), (5,6)],
    'B': [(0,0), (1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (1,3), (2,3), (3,3), (4,3), (0,4), (5,4), (0,5), (5,5), (0,6), (1,6), (2,6), (3,6), (4,6)],
    'C': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (0,3), (0,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    'D': [(0,0), (1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (5,3), (0,4), (5,4), (0,5), (5,5), (0,6), (1,6), (2,6), (3,6), (4,6)],
    'E': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (0,1), (0,2), (0,3), (1,3), (2,3), (3,3), (0,4), (0,5), (0,6), (1,6), (2,6), (3,6), (4,6), (5,6)],
    'F': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (0,1), (0,2), (0,3), (1,3), (2,3), (3,3), (0,4), (0,5), (0,6)],
    'G': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (0,3), (3,3), (4,3), (5,3), (0,4), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    'H': [(0,0), (5,0), (0,1), (5,1), (0,2), (5,2), (0,3), (1,3), (2,3), (3,3), (4,3), (5,3), (0,4), (5,4), (0,5), (5,5), (0,6), (5,6)],
    'I': [(1,0), (2,0), (3,0), (4,0), (2,1), (3,1), (2,2), (3,2), (2,3), (3,3), (2,4), (3,4), (2,5), (3,5), (1,6), (2,6), (3,6), (4,6)],
    'J': [(3,0), (4,0), (5,0), (4,1), (4,2), (4,3), (4,4), (0,5), (4,5), (1,6), (2,6), (3,6)],
    'K': [(0,0), (5,0), (0,1), (4,1), (0,2), (3,2), (0,3), (1,3), (2,3), (0,4), (3,4), (0,5), (4,5), (0,6), (5,6)],
    'L': [(0,0), (0,1), (0,2), (0,3), (0,4), (0,5), (0,6), (1,6), (2,6), (3,6), (4,6), (5,6)],
    'M': [(0,0), (6,0), (0,1), (1,1), (5,1), (6,1), (0,2), (2,2), (4,2), (6,2), (0,3), (3,3), (6,3), (0,4), (6,4), (0,5), (6,5), (0,6), (6,6)],
    'N': [(0,0), (5,0), (0,1), (1,1), (5,1), (0,2), (2,2), (5,2), (0,3), (3,3), (5,3), (0,4), (4,4), (5,4), (0,5), (5,5), (0,6), (5,6)],
    'O': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (5,3), (0,4), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    'P': [(0,0), (1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (1,3), (2,3), (3,3), (4,3), (0,4), (0,5), (0,6)],
    'Q': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (5,3), (0,4), (3,4), (5,4), (0,5), (4,5), (1,6), (2,6), (3,6), (5,6)],
    'R': [(0,0), (1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (5,2), (0,3), (1,3), (2,3), (3,3), (4,3), (0,4), (3,4), (0,5), (4,5), (0,6), (5,6)],
    'S': [(1,0), (2,0), (3,0), (4,0), (0,1), (5,1), (0,2), (1,3), (2,3), (3,3), (4,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    'T': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (2,1), (3,1), (2,2), (3,2), (2,3), (3,3), (2,4), (3,4), (2,5), (3,5), (2,6), (3,6)],
    'U': [(0,0), (5,0), (0,1), (5,1), (0,2), (5,2), (0,3), (5,3), (0,4), (5,4), (0,5), (5,5), (1,6), (2,6), (3,6), (4,6)],
    'V': [(0,0), (6,0), (0,1), (6,1), (1,2), (5,2), (1,3), (5,3), (2,4), (4,4), (2,5), (4,5), (3,6)],
    'W': [(0,0), (6,0), (0,1), (6,1), (0,2), (6,2), (0,3), (3,3), (6,3), (0,4), (2,4), (4,4), (6,4), (0,5), (1,5), (5,5), (6,5), (0,6), (6,6)],
    'X': [(0,0), (6,0), (1,1), (5,1), (2,2), (4,2), (3,3), (2,4), (4,4), (1,5), (5,5), (0,6), (6,6)],
    'Y': [(0,0), (6,0), (1,1), (5,1), (2,2), (4,2), (3,3), (3,4), (3,5), (3,6)],
    'Z': [(0,0), (1,0), (2,0), (3,0), (4,0), (5,0), (5,1), (4,2), (3,3), (2,4), (1,5), (0,6), (1,6), (2,6), (3,6), (4,6), (5,6)],
    '[': [(2,0), (3,0), (4,0), (2,1), (2,2), (2,3), (2,4), (2,5), (2,6), (3,6), (4,6)],
    '\\': [(0,0), (1,1), (2,2), (3,3), (4,4), (5,5), (6,6)],
    ']': [(2,0), (3,0), (4,0), (4,1), (4,2), (4,3), (4,4), (4,5), (2,6), (3,6), (4,6)],
    '^': [(3,0), (2,1), (4,1)],
    '_': [(0,7), (1,7), (2,7), (3,7), (4,7), (5,7), (6,7)],
    '`': [(2,0), (3,1)],
    
    # --- FIXED 'a', 'e', 'f' ---
    'a': [(1,2), (2,2), (3,2), (0,3), (4,3), (1,4), (2,4), (3,4), (4,4), (0,5), (4,5), (1,6), (2,6), (3,6), (4,6)],
    'e': [(1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (1,4), (2,4), (3,4), (4,4), (0,5), (1,6), (2,6), (3,6)],
    'f': [(2,0), (3,0), (1,1), (1,2), (2,2), (3,2), (1,3), (1,4), (1,5)],
    # --------------------------
    
    'b': [(0,0), (0,1), (0,2), (1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (4,4), (0,5), (1,5), (2,5), (3,5)],
    'c': [(1,2), (2,2), (3,2), (4,2), (0,3), (0,4), (1,5), (2,5), (3,5), (4,5)],
    'd': [(4,0), (4,1), (1,2), (2,2), (3,2), (4,2), (0,3), (4,3), (0,4), (4,4), (1,5), (2,5), (3,5), (4,5)],
    'g': [(1,2), (2,2), (3,2), (4,2), (0,3), (5,3), (0,4), (5,4), (1,5), (2,5), (3,5), (4,5), (5,6), (4,7), (3,7), (2,7)],
    'h': [(0,0), (0,1), (0,2), (1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (4,4), (0,5), (4,5)],
    'i': [(2,0), (2,2), (2,3), (2,4), (2,5)],
    'j': [(3,0), (3,2), (3,3), (3,4), (3,5), (0,6), (3,6), (1,7), (2,7)],
    'k': [(0,0), (0,1), (0,2), (3,2), (0,3), (2,3), (0,4), (1,4), (0,5), (3,5)],
    'l': [(2,0), (2,1), (2,2), (2,3), (2,4), (3,5)],
    'm': [(0,2), (1,2), (3,2), (5,2), (0,3), (2,3), (4,3), (0,4), (2,4), (4,4), (0,5), (2,5), (4,5)],
    'n': [(0,2), (1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (4,4), (0,5), (4,5)],
    'o': [(1,2), (2,2), (3,2), (4,2), (0,3), (5,3), (0,4), (5,4), (1,5), (2,5), (3,5), (4,5)],
    'p': [(0,2), (1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (4,4), (0,5), (1,5), (2,5), (3,5), (0,6), (0,7)],
    'q': [(1,2), (2,2), (3,2), (4,2), (0,3), (4,3), (0,4), (4,4), (1,5), (2,5), (3,5), (4,5), (4,6), (4,7)],
    'r': [(0,2), (1,2), (2,2), (3,2), (0,3), (4,3), (0,4), (0,5)],
    's': [(1,2), (2,2), (3,2), (4,2), (0,3), (1,4), (2,4), (3,4), (4,5), (0,6), (1,6), (2,6), (3,6)],
    't': [(2,0), (1,1), (2,1), (3,1), (2,2), (2,3), (2,4), (2,5)],
    'u': [(0,2), (4,2), (0,3), (4,3), (0,4), (4,4), (1,5), (2,5), (3,5), (4,5)],
    'v': [(0,2), (4,2), (0,3), (4,3), (1,4), (3,4), (2,5)],
    'w': [(0,2), (4,2), (0,3), (4,3), (0,4), (2,4), (4,4), (1,5), (3,5)],
    'x': [(0,2), (4,2), (1,3), (3,3), (2,4), (1,5), (3,5)],
    'y': [(0,2), (4,2), (0,3), (4,3), (1,4), (2,4), (3,4), (4,4), (4,5), (1,6), (2,6), (3,6)],
    'z': [(0,2), (1,2), (2,2), (3,2), (4,2), (3,3), (2,4), (1,5), (0,6), (1,6), (2,6), (3,6), (4,6)],
    '{': [(3,0), (2,1), (2,2), (1,3), (2,4), (2,5), (3,6)],
    '|': [(3,0), (3,1), (3,2), (3,3), (3,4), (3,5), (3,6)],
    '}': [(2,0), (3,1), (3,2), (4,3), (3,4), (3,5), (2,6)],
    '~': [(1,2), (0,3), (2,3), (3,3), (4,4)],
}

# ===== Helpers =====
def cell_origin(char_idx: int):
    col = char_idx % CHARS_PER_ROW
    row = char_idx // CHARS_PER_ROW
    return col * CHAR_WIDTH, row * CHAR_HEIGHT

def draw_glyph(points, x0, y0):
    """Draw shadow (optional) then foreground pixels."""
    if ENABLE_SHADOW:
        for (px, py) in points:
            # 1px down-right shadow
            draw.point((x0 + px + 1, y0 + py + 1), fill=SHADOW)
    for (px, py) in points:
        draw.point((x0 + px, y0 + py), fill=FOREGROUND)

def compute_advance(points):
    """Minecraft-like variable width: tight bbox + right padding, clamped."""
    if not points:
        return 4 # Use a default 4px width for 'space'
    minx = min(px for px, _ in points)
    maxx = max(px for px, _ in points)
    # Normalize as if left bearing is 0: use content width only
    content_w = (maxx - minx + 1)
    advance = content_w + RIGHT_PADDING
    advance = max(MIN_ADVANCE, min(MAX_ADVANCE, advance))
    return advance

# ===== Render and measure =====
widths = {}   # codepoint -> advance width in pixels (within 8px cell logic)
for char_idx in range(TOTAL_CHARS):
    code = char_idx + 32   # start at space
    if code > 126:
        continue   # keep ASCII for now
    ch = chr(code)
    x0, y0 = cell_origin(char_idx)

    pts_original = font_patterns.get(ch, [])

    # **CHANGE**: Compute width from ORIGINAL points
    widths[str(code)] = compute_advance(pts_original)
    
    # Shift pattern left so the first lit pixel sits at x=0 (MC packs tight)
    if pts_original:
        minx = min(px for px, _ in pts_original)
        pts_normalized = [(px - minx, py) for (px, py) in pts_original]
    else:
        pts_normalized = [] # No points for 'space'

    draw_glyph(pts_normalized, x0, y0)

# ===== Ensure output directory =====
# Use a relative path from the script's location
script_dir = os.path.dirname(os.path.abspath(__file__))
out_dir = os.path.join(script_dir, 'assets')
os.makedirs(out_dir, exist_ok=True)

# ===== Save outputs =====
png_path = os.path.join(out_dir, 'font.png')
meta_path = os.path.join(out_dir, 'font_widths.json')

img.save(png_path)
with open(meta_path, 'w', encoding='utf-8') as f:
    json.dump({
        "cell_size": [CHAR_WIDTH, CHAR_HEIGHT],
        "grid": [CHARS_PER_ROW, CHARS_PER_COL],
        "first_codepoint": 32,
        "last_codepoint": 126,
        "advance_widths_px": widths   # codepoint (str) -> advance px within cell
    }, f, indent=2)

print(f"Font atlas generated: {png_path}")
print(f"Widths written: {meta_path}")
print(f"Atlas size: {IMAGE_WIDTH}x{IMAGE_HEIGHT} px")
print(f"Cell size: {CHAR_WIDTH}x{CHAR_HEIGHT} px")